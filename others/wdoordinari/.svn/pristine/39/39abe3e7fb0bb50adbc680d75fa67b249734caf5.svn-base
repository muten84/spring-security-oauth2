import {
    Component, ViewEncapsulation,
    OnInit, ViewChild, OnDestroy
} from "@angular/core";
import { ComponentHolderService } from "app/service/shared-service";
import {
    StormoModuleServiceApi,TransportModuleServiceApi, VehicleDirectAssignmentFilter,AcknowledgeResp,
    AvailableParkingVehicleTurnDTO, VehicleDirectAssignmentDTO,
    ServiceDTO, ParkingServiceApi, Value, TsServiceResourceDTO,
    InterventionDTO, RequestInterventionUnifiedService, InterventionActivityDTO,
    MoveInterventionPositionRequestDTO, MoveInterventionRequestDTO, CheckResultDTO, GenericResultDTO, VehiclePositionToChangeRequest
} from "services/services.module";
import { Router, ActivatedRoute } from "@angular/router";
import { GestioneServiziHeaderComponent } from "app/gestione-servizi/gestione-servizi-header.component";
import { DatatableComponent } from "@swimlane/ngx-datatable";
import { throttleable } from "@swimlane/ngx-datatable/release/utils";
import { Observable, Subject } from "rxjs";
import { StaticDataService } from "app/static-data/cached-static-data";
import { valueToSelect } from "app/util/convert";
import { NgbModal } from "@ng-bootstrap/ng-bootstrap";
import { ChiusuraMezzoModal } from "app/gestione-servizi/chiusura-mezzo.modal";
import * as moment from 'moment';
import { CoreTableColumn, CoreTableComponent } from "app/core/table/core-table/core-table.component";
import { VehicleDetailComponent } from "app/gestione-servizi/vehicle-detail.component";
import { BehaviorSubject } from "rxjs/BehaviorSubject";

import { ServiceCommon } from "app/common-servizi/service-common";
import { MessageService } from "app/service/message.service";
import { TokenService } from '../service/token.service';
import { EVENTS } from "app/util/event-type";
import { ServiziService } from "../service/servizi-service";
import { BrowserCommunicationService } from "common/services/browser-communication.service";
import { Message, SelectServiceInSinottico, Type } from "common/services/messages";
import { environment } from "environments/environment";
import { TextModalComponent } from "../modals/text-modal/text-modal-component";
import { CrewMemberModalComponent } from "../modals/crew-member-modal/crew-member-modal-component";

function execute(context: any, funct: { (obj: any): any }): { (obj: any): any } {
    return function (obj: any) {
        return funct.call(context, obj);
    }
}

@Component({
    selector: 'gestione-servizi',
    templateUrl: './gestione-servizi-component.html',
    styleUrls: ['./gestione-servizi-component.scss'],
    encapsulation: ViewEncapsulation.None,
})
export class GestioneServiziComponent implements OnInit, OnDestroy {

    @ViewChild('mezziDisponibiliTable') mezziDisponibiliTable: CoreTableComponent;

    public model: ServiceDTO = {};

    public unifiedService: RequestInterventionUnifiedService = {
        trasportoCorrente: null,
        prenotazioneCorrente: null,
        risorsaDelServizio: null
    };

    public currentId: string;

    private currentUser;

    public rilievoTappa = false;

    public rilievoSostaTappa = false;

    //configurazioni mezzi assegnati
    public columnsMezziAssegnati: Array<CoreTableColumn> = [
        { title: 'Codice Mezzo', name: 'resourceCode', sort: 'asc', style: { "flex-grow": "30", } },
        { title: 'Attivazione', name: 'activationDate', style: { "flex-grow": "30", } },
        { title: 'Partenza', name: 'startDate', style: { "flex-grow": "30", } },
        {
            title: '', name: '', optionTitle: 'resourceCode', options: [{
                name: 'Rilascia il mezzo dal servizio',
                icon: 'mdi mdi-ambulance',
                clicked: execute(this, this.removeVehicle)
            },
            {
                name: 'Partenza del mezzo',
                icon: 'mdi mdi-arrow-right-box',
                clicked: execute(this, this.startVehicle),
                enabled: function (row: TsServiceResourceDTO): boolean {
                    return !row.startDate;
                },
            },
            {
                name: 'Proprietà',
                icon: 'mdi mdi-information-outline',
                clicked: execute(this, this.vehicleProperty)
            }, {
                name: 'SEPARATOR',
                icon: ' '
            },
            {
                name: 'Riattivazione del mezzo',
                icon: 'mdi mdi-repeat ',
                clicked: execute(this, this.vehicleRiactivation)
            }
            ], style: { "flex-grow": "5" }
        }
    ];
    public configMezziAssegnati = {
        paging: true,
        sorting: { columns: this.columnsMezziAssegnati },
        filtering: { filterString: '' },
    };

    //    @ViewChild(MezziAssegnatiComponent) mezziAssegnatiTable: MezziAssegnatiComponent;
    //    @ViewChild(MezziTurnoComponent) mezziTurnoTable: MezziTurnoComponent;
    //    @ViewChild(PrenotazioniAccorpateComponent) prenotazioniAccorpateTable: PrenotazioniAccorpateComponent;


    //configurazioni mezzi in turno 
    public listMezziTurno: Array<AvailableParkingVehicleTurnDTO> = [];
    public columnsMezziTurno: Array<CoreTableColumn> = [
        { title: 'Codice', name: 'vehicleCode', index: 1, style: { "flex-grow": "15" } },
        /* { title: 'Note', name: 'note', style: { width: "10%",  } },*/
        { title: 'Orario', name: 'stopLocationDate', index: 2, style: { "flex-grow": "5" } },
        { title: 'Postazione', name: 'stopLocation', index: 3, style: { "flex-grow": "15" } },
        { title: 'Destinazione', name: 'nextParkingCode', index: 4, style: { "flex-grow": "15" } },
        { title: 'In', index: 5, name: 'startTurnDate', style: { "flex-grow": "5" } },
        { title: 'Out', index: 6, name: 'endTurnDate', style: { "flex-grow": "5" } },
        {
            title: '', name: '', index: 7, optionTitle: 'vehicleCode', options: [{
                name: 'Assegna al servizio',
                icon: 'mdi mdi-ambulance',
                clicked: execute(this, this.assignVehicle),
            }, {
                name: 'SEPARATOR',
                icon: ' '
            },
            {
                name: 'Proprietà',
                icon: 'mdi mdi-information-outline',
                clicked: execute(this, this.vehicleProperty)
            },
            {
                name: 'Modifica Posizione',
                icon: 'mdi mdi-lead-pencil',
                clicked: execute(this, this.modifyPosition)
            }], style: { "flex-grow": "5" }
        }
    ];
    public configMezziTurno = {
        paging: true,
        sorting: { columns: this.columnsMezziTurno },
        filtering: { filterString: '' },
    };

    //configurazioni telefoni
    public listTelefoni: Array<any> = [];
    public columnsTelefoni: Array<CoreTableColumn> = [
        { title: 'Telefoni', name: 'telefono', style: {} },
    ];
    public configTelefoni = {
        paging: true,
        sorting: { columns: this.columnsTelefoni },
        filtering: { filterString: '' },
    };


    //configurazioni prenotazioni accorpate
    public columnsPrenotazioni: Array<CoreTableColumn> = [
        /*    { title: 'Indice', name: 'idx', index: 1, sort: 'asc', style: { "flex-grow": "0"  } },*/
        { title: 'Codice', name: 'bookingCode', index: 2, style: { "flex-grow": "2" } },
        { title: 'A', name: 'columnA.name', index: 3, style: { "flex-grow": "1" } },
        { title: 'Tappa', name: 'addressType', index: 4, style: { "flex-grow": "3" } },
        { title: 'Deambulazione', name: 'statusCompanion', index: 5, style: { "flex-grow": "1", } },
        { title: 'Trasporto', name: 'transportDate', index: 6, style: { "flex-grow": "2" } },
        { title: 'Indirizzo', name: 'address', index: 7, style: { "flex-grow": "6" } },
        { title: 'Trasportato', name: 'transported', index: 8, style: { "flex-grow": "4" } },
        { title: 'Tipo Pausa', name: 'pauseType', index: 9, style: { "flex-grow": "4" } },
        {
            title: '', name: '', index: 10, optionTitle: 'bookingCode', options: [
               /* {
                    name: 'Sposta la tappa in alto',
                    icon: 'mdi mdi-arrow-collapse-up',
                    clicked: execute(this, this.moveStageFirst)
                }, {
                    name: 'Sposta la tappa su',
                    icon: 'mdi mdi-arrow-up',
                    clicked: execute(this, this.moveStageUp)
                }, {
                    name: 'Sposta la tappa giù',
                    icon: 'mdi mdi-arrow-down',
                    clicked: execute(this, this.moveStageDown)
                }, {
                    name: 'Sposta la tappa in fondo',
                    icon: 'mdi mdi-arrow-collapse-down',
                    clicked: execute(this, this.moveStageLast)
                }, {
                    name: 'SEPARATOR',
                    icon: ' '
                }, */{
                    name: 'Rileva dati sulla tappa',
                    icon: 'mdi mdi-ambulance',
                    clicked: execute(this, this.retriveStageData)
                }, {
                    name: 'Rileva dati di sosta sulla tappa',
                    icon: 'mdi mdi-ambulance',
                    clicked: execute(this, this.retriveStagePauseData)
                }, {
                    name: 'SEPARATOR',
                    icon: ' '
                }, {
                    name: 'Rimuovi dal servizio',
                    icon: 'mdi mdi-table-column-remove',
                    clicked: execute(this, this.removeStage)
                }, {
                    name: 'SEPARATOR',
                    icon: ' '
                }, /*{
                    name: 'Proprietà della Prenotazione',
                    icon: 'mdi mdi-information-outline',
                    clicked: execute(this, this.stageProperty)
                }, {
                    name: 'Dettaglio indirizzi',
                    icon: 'mdi mdi-information-outline',
                    clicked: execute(this, this.addressDetail)
                },*/ {
                    name: 'Dati della Prenotazione',
                    icon: 'mdi mdi-information-outline', /*mdi mdi-lead-pencil',*/
                    clicked: execute(this, this.stageModify)
                }
            ], style: { "flex-grow": "1" }
        }
    ];
    public configPrenotazioni = {
        paging: true,
        sorting: { columns: this.columnsPrenotazioni },
        filtering: { filterString: '' },
    };

    public moveBooking(moveAction: string) {
        if (!this.penotazioneSelected) {
            this.componentService.getRootComponent().showToastMessage('warning', 'Selezionare una prenotazione dalla lista!');
        } else {
            switch (moveAction) {
                case "moveFirst":
                    this.moveStageFirst(this.penotazioneSelected);
                    break;
                case "moveUp":
                    this.moveStageUp(this.penotazioneSelected);
                    break;
                case "moveDown":
                    this.moveStageDown(this.penotazioneSelected);
                    break;
                case "moveLast":
                    this.moveStageLast(this.penotazioneSelected);
            }
        }
    }

    //configurazioni mezzi intervenuti
    public listMezziIntervenuti: Array<InterventionActivityDTO> = [];
    public columnsMezziIntervenuti: Array<CoreTableColumn> = [
        { title: 'Mezzo', name: 'resourceCode', style: {} },
        { title: 'Ora Arrivo', name: 'timestampArrival', style: {} },
        { title: 'Ora Partenza', name: 'timestampDeparture', style: {} },
        { title: 'Pausa', name: 'pause', style: {} },
        { title: 'Unità Pausa', name: 'pauseMu', style: {} },
        {
            title: '', name: '', options: [
                {
                    name: 'Proprietà',
                    icon: 'fa fa-info-circle',
                    clicked: execute(this, this.vehicleProperty)
                }
            ], style: { width: "50px" }
        }
    ];
    public configMezziIntervenuti = {
        paging: true,
        sorting: { columns: this.columnsMezziIntervenuti },
        filtering: { filterString: '' },
    };

    @ViewChild("prenotazioniTable") prenotazioniTable: CoreTableComponent;

    // Variabili di appoggio
    //Mezzo selezionato da quelli in turno
    public selectedVehicle;
    // mezzo fisico
    public phisicalVehicle: VehicleDirectAssignmentDTO;
    // mezzo in turno selezionato
    public vehicleTurn: AvailableParkingVehicleTurnDTO;
    // Mezzo assegnato  selezionato
    public vehicleAssigned: TsServiceResourceDTO;
    // prenotazione selezionata
    public penotazioneSelected: InterventionDTO;


    //check tutti i mezzi
    public allVehicles = false;
    // check mezzi disponibili a breve
    public toBeFree = false;

    // Assegnazione diretta
    public directAssign = false;
    // Accorpato
    public merged = false;
    //  destinazione
    public parking: Value;

    // lista mezzi fisici
    public vehicles = new Subject();
    // lista postazioni
    public parkings: Observable<Array<any>>;
    // lista tipi di sosta
    public pauseTypes: BehaviorSubject<Array<any>>;

    // tipo pausa
    public pauseTypeTemp: string;

    // sottoscrizione agli eventi pushing
    private serviceSubscription;

    private vehicleSubscription;

    private sendRowIdLs: (ev: Message) => void;

    constructor(
        private componentService: ComponentHolderService,
        private transportService: TransportModuleServiceApi,
        private stormoService: StormoModuleServiceApi,
        private route: ActivatedRoute,
        private parkingService: ParkingServiceApi,
        private sdSvc: StaticDataService,
        private modalService: NgbModal,
        private staticService: StaticDataService,
        private router: Router,
        private messageService: MessageService,
        private tokenService: TokenService,
        private serviceCommon: ServiceCommon,
        private serviziService: ServiziService,
        private bcs: BrowserCommunicationService
    ) { }

    public ngOnInit() {
        //TODO aggiornare i dati sull'header
        this.getCurrentUser();

        this.currentId = this.route.snapshot.params['id'];

        this.parkings = this.sdSvc.getStaticDataByType('POSTAZIONE_ARRIVO').map(valueToSelect);
        //lista dei tipi di pausa
        this.pauseTypes = new BehaviorSubject<Array<any>>([]);

        this.serviziService.setGestioneServiziComponent(this);

        this.transportService.loadPauseType().subscribe(res => {
            this.pauseTypes.next(res.resultList);
        });

        this.serviceSubscription = this.messageService.subscribe(EVENTS.SERVICE);
        this.serviceSubscription.observ$.subscribe((msg) => {
            console.log('received message from topic ' + msg.topic + " - " + JSON.stringify(msg));
            if (msg.data.action && msg.data.action != "ALERT") {
                //disaccoppia contesto subscribe da gestione evento 
                //- in caso di errore lascia sottoscrizione e individua riga errore
                setTimeout(() => {
                    this.evaluatePushingEvent(msg);
                }, 0);//Chiudi timeout
            }
        });

        this.vehicleSubscription = this.messageService.subscribe(EVENTS.VEHICLE);
        this.vehicleSubscription.observ$.subscribe((msg) => {
            console.log('received message from topic ' + msg.topic + " - " + JSON.stringify(msg));
            //disaccoppia contesto subscribe da gestione evento 
            //- in caso di errore lascia sottoscrizione e individua riga errore
            setTimeout(() => {
                this.evaluatePushingEventVehicle(msg);
            }, 0);//Chiudi timeout
        });
        //all'init carico servizio
        this.refreshService();
        this.initListener();
    }

    private initListener() {
        this.sendRowIdLs = (ev: Message) => {
            let param: SelectServiceInSinottico = {
                serviceCode: this.model.code,
                serviceId: this.model.id
            }
            this.bcs.postMessage(Type.APP2_SET_CURRENT_SERVICE, param, "*");
        };
        this.bcs.addEventListener(Type.APP2_GET_SELECTED_BOOKING, this.sendRowIdLs);
    }

    private evaluatePushingEvent(msg) {
        if (msg.data.action && msg.data.action != "ALERT") {
            let ids: string[] = msg.data.payload.split(",");

            if (ids && ids.length > 0 && this.model.id && msg.data.from != this.currentUser) {
                for (var i = 0; i < ids.length; i++) {
                    if (ids[i] === this.model.id) {
                        if (msg.data.action == "ARCHIVE" || msg.data.action == "DELETE") {
                            this.router.navigate(['/sinottico-servizi']);
                        } else {
                            this.refreshService();
                        }
                        /*this.componentService.getRootComponent().unmask();
                        this.componentService.getRootComponent().showConfirmDialog('Attenzione!', "Sono state effettuate delle modifiche dall'utente '" + msg.data.from + "'. \nE' necessario ricaricare dati. Procedere?").then((result) => {
                            console.log("dati modificati lato server: forzo refresh");
                            this.refreshService();
                        }, (reason) => {
                            console.log("dati modificati lato server: non forzo refresh");
                        });*/
                    }
                }
            }
        }
    }

    private evaluatePushingEventVehicle(msg) {
        let action = msg.data.action;
        if (msg.data.payload) {
            //lista di id delle resource da allarmare
            let idResources: Array<string> = msg.data.payload.split(",");
            let trovato = false;
            //cerco nella lista dei mezzi assegnati
            if (this.model.serviceResourceList) {
                this.model.serviceResourceList.forEach(sr => {
                    if (!trovato) {
                        trovato = this.checkPresentElementIntoArray(idResources, sr.resourceId);
                    }
                });
            }
            if (trovato) {
                //se ho trovato un mezzo tra quelli assegnati, effettuo il refresh del servizio
                this.refreshService();
            } else {
                //nel caso è stato rimosso un veicolo da un servizio va fatto refresh lista disponibili
                if (action == "REMOVE") {
                    // se ho trovato un mezzo tra quelli disponibili, effettuo il refresh della stessa lista
                    this.refreshVehicleTurn(this.allVehicles, this.toBeFree);
                } else {
                    //Cerco nella lista dei mezzi disponibili
                    let trovato = false;
                    if (this.listMezziTurno) {
                        this.listMezziTurno.forEach(sr => {
                            if (!trovato) {
                                trovato = this.checkPresentElementIntoArray(idResources, sr.vehicleId);
                            }
                        });
                    }
                    if (trovato) {
                        // se ho trovato un mezzo tra quelli disponibili, effettuo il refresh della stessa lista
                        this.refreshVehicleTurn(this.allVehicles, this.toBeFree);
                    }
                }
            }
        }
    }

    private checkPresentElementIntoArray(idList: Array<string>, idSearch: string): boolean {
        let esito = false;
        if (idList && idList.length > 0 && idSearch && idSearch.length > 0) {
            idList.forEach(element => {
                if (element == idSearch) {
                    esito = true;
                }
            });
        }
        return esito;
    }

    public getCurrentUser() {
        this.currentUser = this.tokenService.getUserName();
        if (this.currentUser) {
            console.log("################## CURRENT_USER:" + this.currentUser);
            return true;
        } else {
            return false;
        }
    }

    ngOnDestroy() {
        this.serviceSubscription.observ$.unsubscribe();
        this.vehicleSubscription.observ$.unsubscribe();

        this.serviziService.setGestioneServiziComponent(null);
        if (this.sendRowIdLs) {
            this.bcs.removeEventListener(Type.APP2_GET_SELECTED_BOOKING, this.sendRowIdLs);
        }

        this.sendMessageToSinottico({});
    }

    @throttleable(5)
    public onPanelChange(event) {

        //      this.mezziAssegnatiTable.recalculate();
        //      this.mezziTurnoTable.recalculate();
        //      this.prenotazioniAccorpateTable.recalculate();

    }

    //Mezzi assegnati
    public selectedMezziAssegnati(ev) {
        this.vehicleAssigned = ev;
    }

    public getVehicleAlarm(row: TsServiceResourceDTO): string {
        if (row.alarm) {
            //allarme 
            return "fa fa-exclamation";
        } else {
            return "";
        }
    }

    // mezzi in turno
    public selectedMezziTurno(selected: AvailableParkingVehicleTurnDTO) {
        if (selected) {
            this.directAssign = false;

            this.vehicleTurn = selected;
            console.log("selected" + this.vehicleTurn.vehicleCode);

            this.phisicalVehicle = {
                id: this.vehicleTurn.vehicleId,
                vehicleCode: this.vehicleTurn.vehicleCode
            };

            if (selected.telephoneList) {
                this.listTelefoni = selected.telephoneList;
            }

        } else {
            this.vehicleTurn = null;
            this.phisicalVehicle = null;
        }
    }

    public getVehicleStatus(row: AvailableParkingVehicleTurnDTO): string {
        if (row.nextParkingCode) {
            //mezzo in viaggio 
            return "fa fa-arrow-circle-right";
        } else {
            return "";
        }
    }

    public assignVehicle(el?: AvailableParkingVehicleTurnDTO) {
        if (this.phisicalVehicle) {
            this.componentService.getRootComponent().mask();
            //console.log("merged:"+this.merged);
            let model = {
                vehicleId: this.phisicalVehicle.id,
                serviceId: this.model.id,
                inAppoggio: this.merged
            };

            this.transportService.addVehicleToService(model).catch((e, o) => {
                this.componentService.getRootComponent().showToastMessage('error', 'Errore nell\'assegnamento del mezzo');
                this.componentService.getRootComponent().unmask();
                return [];
            }).subscribe(res => {
                this.componentService.getRootComponent().showToastMessage('success', 'Mezzo assegnato');
                this.refreshService();
                //invia stormo activation
                this.sendStormoActivation(model.vehicleId, this.phisicalVehicle.vehicleCode,model.serviceId);
            });
        } else {
            this.componentService.getRootComponent().unmask();
            this.componentService.getRootComponent().showToastMessage('error', 'Selezionare un mezzo da assegnare');
        }
    }

    public sendStormoActivation(resId:string, resCode:string, servId:string){
         //invia stormo activation
         let req={resourceId:resId, resourceCode:resCode,serviceId:servId};
         this.stormoService.sendActivation(req).catch((e, o) => {
             this.componentService.getRootComponent().showToastMessage('error', 'Errore servizio stormo');
             return [];
         }).subscribe(res2 => {
             if (AcknowledgeResp.OutEnum.ACK!=res2.out) {
                 this.componentService.getRootComponent().showToastMessage('error',"Non e' stato possibile inviare il servizio \nalle unita' mobili in turno sul mezzo " + resCode + ".");
             }                    
         });
    }

    public sendStormoCleanActivation(resId:string, resCode:string, servId:string){
        //invia stormo activation
        let req={resourceId:resId, resourceCode:resCode,serviceId:servId};
        this.stormoService.cleanActivation(req).catch((e, o) => {
            this.componentService.getRootComponent().showToastMessage('error', 'Errore servizio stormo');
            return [];
        }).subscribe(res2 => {
            if (AcknowledgeResp.OutEnum.ACK!=res2.out) {
                this.componentService.getRootComponent().showToastMessage('error',"Non e' stato possibile annullare il servizio \nnelle unita' mobili in turno sul mezzo " + resCode + ".");
            }                    
        });
    }

    public sendStormoUpdateActivation(servId:string){
    //invia stormo activation
        let req={serviceId:servId};
        this.stormoService.updateActivation(req).catch((e, o) => {
            this.componentService.getRootComponent().showToastMessage('error', 'Errore servizio stormo');
            return [];
        }).subscribe(res2 => {
            if (AcknowledgeResp.OutEnum.ACK!=res2.out) {
                this.componentService.getRootComponent().showToastMessage('error',"Non e' stato possibile aggiornare il servizio \na tutte le unita' mobili impegnate su di esso.");
            }                    
        });
    }   

    public removeVehicle(resource?: TsServiceResourceDTO) {
        let model;
        if (resource) {
            this.vehicleAssigned = resource;
        }
        if (this.vehicleAssigned) {

            let modal = this.modalService.open(ChiusuraMezzoModal, { size: 'sm' });
            modal.result.then((result) => {
                let serviceIdSelected = this.vehicleAssigned.serviceId;
                if (result) {
                    model = {
                        vehicleId: this.vehicleAssigned.resourceId,
                        serviceId: this.vehicleAssigned.serviceId,
                        parkingId: this.vehicleAssigned.parkingId,
                        reason: result.id
                    };
                    this.componentService.getRootComponent().mask();
                    this.transportService.releaseVehicleFromService(model).catch((e, o) => {
                        this.componentService.getRootComponent().showToastMessage('error', 'Errore nel rilascio del mezzo');
                        this.componentService.getRootComponent().unmask();
                        return [];
                    }).subscribe(res => {
                        this.componentService.getRootComponent().showToastMessage('success', 'Mezzo rimosso');
                        //Stormo clean activation
                        this.sendStormoCleanActivation(model.vehicleId, this.vehicleAssigned.resourceCode,model.serviceId);
                        if (!(res && res.list && res.list.length > 0)) {
                            this.archiveService(serviceIdSelected, this.model.code, true);
                        } else {
                            this.refreshService();
                        }
                    });
                }
            }, (reason) => {
            });

        } else {
            this.componentService.getRootComponent().showToastMessage('error', 'Selezionare un mezzo da rimuovere');
        }
    }

    public async callArchiveService() {
        this.archiveService(this.model.id, this.model.code, false);
    }

    public async archiveService(id: string, serviceCode: string, fromRemove: boolean) {
        this.componentService.getRootComponent().mask();
        let checkIsManaged = await this.serviceCommon.checkIsManaged(id);
        if (checkIsManaged.ok) {
            let ret = await this.serviceCommon.checkAndArchiveService(id, serviceCode, checkIsManaged.ok);
            if (ret) {
                //vai al sinottico servizi
                this.router.navigate(['/sinottico-servizi']);
            } else {
                if (fromRemove) { this.refreshService(); }
            }
        } else {
            this.componentService.getRootComponent().unmask();
            if (!fromRemove) {
                this.componentService.getRootComponent().showModal('warning', 'Archiviazione impossibile! Nessun mezzo è stato associato al servizio.');
            }else{
                this.refreshService();
            }
        }
        this.componentService.getRootComponent().unmask();
    }


    /*public checkArchivableService(serviceId: string){
        if(serviceId==null || serviceId.length==0)
            return false;
        this.transportService.checkArchivableService(serviceId).catch((e, o) => {
            this.componentService.getRootComponent().showToastMessage('error', 'Errore check archiviazione del servizio');
            return [];
        }).subscribe(resCheck => {
            let esito = resCheck; 
            if(esito && esito.isOk())                    
           return resCheck.isOk();
        });
    }*/

    public refreshService() {
        this.componentService.getRootComponent().mask();

        this.transportService.getServiceById(this.currentId).catch((e, o) => {
            this.componentService.getRootComponent().showToastMessage('error', 'Errore nel caricamento del servizio');
            return [];
        }).subscribe(service => {
            this.componentService.getRootComponent().mask();
            let header = <GestioneServiziHeaderComponent>this.componentService.getHeaderComponent('gestioneServiziHeaderComponent');
            if (header) {
                header.setModel(service);
            }
            this.model = service;
            this.vehicleAssigned = null;
            this.refreshVehicleTurn(this.allVehicles, this.toBeFree);

            this.cleanInterventionUnified();
            this.listMezziIntervenuti = [];

            this.reselectTables();
            this.componentService.getRootComponent().unmask();

            // invio il messaggio alla popup se è aperta
            this.sendMessageToSinottico(this.model);
        });
    }

    sendMessageToSinottico(currentTransport: ServiceDTO) {
        let param: SelectServiceInSinottico = {
            serviceCode: this.model.code,
            serviceId: this.model.id
        }
        this.bcs.postMessage(Type.APP2_SET_CURRENT_SERVICE, param);
    }

    public reselectTables() {
        if (this.penotazioneSelected && this.prenotazioniTable) {
            this.prenotazioniTable.selectByproperty("id", this.penotazioneSelected.id);
        }
    }

    public refreshPhisicalVehicles(code: string) {
        let model: VehicleDirectAssignmentFilter = {};
        if (code) {
            model.vehicleCode = code.toUpperCase();
        }

        this.transportService.searchDirectAssignmentVehicle(model).catch((e, o) => {
            this.componentService.getRootComponent().showToastMessage('error', 'Errore nel caricamento dei mezzi');
            return [];
        }).subscribe(res => {
            this.vehicles.next(res.resultList);
        });

    }

    //salvataggio dati servizio
    public saveService() {
        let data = {
            serviceId: this.model.id,
            note: this.model.note,
            km: this.model.km
        };
        this.transportService.saveService(data).catch((e, o) => {
            this.componentService.getRootComponent().showToastMessage('error', 'Errore nel salvataggio dei dati del servizio');
            return [];
        }).subscribe(res => {
            this.componentService.getRootComponent().showToastMessage('success', 'Salvataggio dati avvenuto con successo');
            this.model = res;
        });
    }

    // check assegnazione diretta
    public setDirectAssign(check: boolean) {
        if (check) {
            this.phisicalVehicle = null;
            this.vehicleTurn = null;

            //     this.mezziTurnoTable.clean();
        } else {
        }
    }


    // check tutti i mezzi
    public refreshVehicleTurn(all: boolean, toBeFree: boolean) {
        if (all === true) {
            this.toBeFree = false;
        }
        if (toBeFree === true) {
            this.allVehicles = false;
        }

        this.componentService.getRootComponent().mask();
        let filter = {
            ckAllResourceFlag: all
        };
        let listener = (res: GenericResultDTO) => {
            this.componentService.getRootComponent().unmask();
            this.listMezziTurno = res.resultList || [];
            this.phisicalVehicle = null;
            this.vehicleTurn = null;
            //    console.log("loaded vehicle in turn", res);
        };
        if (toBeFree) {
            this.transportService.shortlyAvailableVehicles(filter).subscribe(listener);
        } else {
            this.transportService.selectAvailableVehicleTurn(filter).subscribe(listener);
        }
    }

    // invia mezzo a destinazione
    public moveInterventionOnDestination() {

        if (!this.vehicleTurn) {
            this.componentService.getRootComponent().showToastMessage('warning', 'Selezionare un mezzo disponibile dalla lista!');
        } else if (this.parking == null) {
            this.componentService.getRootComponent().showToastMessage('warning', 'Selezionare una postazione di Destinazione!');
        } else {
            this.componentService.getRootComponent().mask();
            let model: MoveInterventionPositionRequestDTO = {
                destinationId: this.parking.id,
                vehicleTurnId: this.vehicleTurn.vehicleTurnId
            }
            this.transportService.moveInterventionOnDestination(model).subscribe(res => {
                let parkingVehicleTurn: AvailableParkingVehicleTurnDTO = res.result;
                this.replaceVehicleTurn(parkingVehicleTurn);
                this.componentService.getRootComponent().unmask();
            });
        }
    };

    // rientro del mezzo
    public moveInterventionOnArrival() {

        if (!this.vehicleTurn) {
            this.componentService.getRootComponent().showToastMessage('warning', 'Selezionare un mezzo disponibile dalla lista!');
        } else {
            this.componentService.getRootComponent().mask();
            let model: MoveInterventionPositionRequestDTO = {
                vehicleTurnId: this.vehicleTurn.vehicleTurnId
            }
            this.transportService.moveInterventionOnArrival(model).subscribe(res => {
                let parkingVehicleTurn: AvailableParkingVehicleTurnDTO = res.result;
                this.replaceVehicleTurn(parkingVehicleTurn);
                this.componentService.getRootComponent().unmask();
            });
        }
    };

    private replaceVehicleTurn(resTurno: AvailableParkingVehicleTurnDTO) {
        let appList: Array<AvailableParkingVehicleTurnDTO> = [];
        appList = this.listMezziTurno.slice();
        let index: number = 0;
        for (index = 0; index < appList.length; index++) {
            let currTurno = appList[index];
            if (resTurno.vehicleTurnId == currTurno.vehicleTurnId) {
                appList[index] = resTurno;
                break;
            }
        }
        this.listMezziTurno = appList.slice();
        appList = undefined;
    };

    // partenza mezzo
    public startVehicle(row: TsServiceResourceDTO) {
        let model = {
            serviceResourceId: row.id
        }
        this.transportService.vehicleStart(model).catch((e, o) => {
            return [];
        }).subscribe(res => {
            this.refreshService();
        });

    }

    // modifica la posizione
    public modifyPosition(row: AvailableParkingVehicleTurnDTO) {
        //faccio apparire la popup per chiedere quale postazione inserire

        let modal = this.modalService.open(TextModalComponent, { size: 'sm' });

        modal.componentInstance.title = "Inserisci la postazione";
        modal.componentInstance.label = "Postazione";

        modal.result.then((result) => {
            // 
            if (result) {
                this.componentService.getRootComponent().mask();
                //  
                let body: VehiclePositionToChangeRequest = {
                    vehicleId: row.vehicleId,
                    positionName: result
                };
                this.transportService.modifyInterventionPosition(body).subscribe(res => {
                    this.componentService.getRootComponent().unmask();
                    this.refreshVehicleTurn(this.allVehicles, this.toBeFree);
                });
            }
        }, (reason) => {
        });

    }

    //  AvailableParkingVehicleTurnDTO | TsServiceResourceDTO | InterventionActivityDTO
    public vehicleProperty(v) {
        //visualizzare la popup col dettaglio del mezzo
        let vehicleCode = v.vehicleCode || v.resourceCode;

        if (vehicleCode) {
            let modal = this.modalService.open(VehicleDetailComponent, { size: 'lg' });
            modal.componentInstance.vehicleCode = vehicleCode;
        }
    }

    // riattivazione mezzo sul servizio
    public vehicleRiactivation(row: TsServiceResourceDTO) {
        let body = { idServiceResource: row.id };
        this.transportService.activationVehicleService(body).subscribe(res => {
            this.componentService.getRootComponent().showToastMessage('success', 'Mezzo ' + res.resourceCode + ' riattivato');
            //invia stormo activation
            this.sendStormoActivation(row.resourceId, row.resourceCode,row.serviceId);
        });
    }

    // ------------------- 
    // metodi contestuali alle prenotazioni accorpate

    public getTappaIcon(row: InterventionDTO): string {
        if (!row.arrived && !row.departed) {
            //nero
            return "";
        } else if (row.arrived && row.departed) {
            //bianco
            return "fa fa-check-square";
        } else {
            //grigio
            return "fa fa-check";
        }
    }

    //prenotazione selezionata
    public selectedPrenotazioni(ev: InterventionDTO) {
        this.penotazioneSelected = ev;
        //carico i mezzi intervenuti 
        this.listMezziIntervenuti = ev.interventionActivities;

        if (this.unifiedService &&
            this.unifiedService.prenotazioneCorrente &&
            ev.id !== this.unifiedService.prenotazioneCorrente.id) {
            this.cleanInterventionUnified();
        }
    }
    // salva la timbratura
    public setInterventionUnified() {

        let modelToSave = JSON.parse(JSON.stringify(this.unifiedService));

        // pulisco l'oggetto dai campi di appoggio
        modelToSave.orarioTappaObj = undefined;
        modelToSave.orarioTappa = moment((<any>this.unifiedService).orarioTappaObj, 'HH:mm');
        this.componentService.getRootComponent().mask();
        this.transportService.setInterventionUnified(modelToSave).subscribe(res => {
            this.componentService.getRootComponent().showToastMessage('success', 'Salvataggio dati avvenuto con successo');
            this.refreshService();
            this.rilievoTappa = false;
            this.componentService.getRootComponent().unmask();
        });

    }

    public cleanInterventionUnified() {
        this.rilievoSostaTappa = false;
        this.rilievoTappa = false;
        this.unifiedService = {
            trasportoCorrente: null,
            risorsaDelServizio: null,
            prenotazioneCorrente: null,
        };
    }

    // salva dati rilievo pausa tappa
    public setInterventionPause() {
        this.componentService.getRootComponent().mask();

        let model = {
            serviceId: this.model.id,
            interventionId: this.penotazioneSelected.id,
            pauseType: this.pauseTypeTemp
        };

        this.transportService.setInterventionStopType(model).subscribe(ret => {
            this.componentService.getRootComponent().unmask();
            this.componentService.getRootComponent().showToastMessage('success', 'Salvataggio dati avvenuto con successo');
            this.refreshService();
        });
    }

    public moveStageFirst(stage: InterventionDTO) {
        this.sendMoveStageRequest(stage, MoveInterventionRequestDTO.ShiftEnum.FIRST);
        this.sendStormoUpdateActivation(stage.serviceId);
    }

    public moveStageUp(stage: InterventionDTO) {
        this.sendMoveStageRequest(stage, MoveInterventionRequestDTO.ShiftEnum.UP);
        this.sendStormoUpdateActivation(stage.serviceId);
    }

    public moveStageDown(stage: InterventionDTO) {
        this.sendMoveStageRequest(stage, MoveInterventionRequestDTO.ShiftEnum.DOWN);
        this.sendStormoUpdateActivation(stage.serviceId);
    }

    public moveStageLast(stage: InterventionDTO) {
        this.sendMoveStageRequest(stage, MoveInterventionRequestDTO.ShiftEnum.LAST);
        this.sendStormoUpdateActivation(stage.serviceId);
    }

    private sendMoveStageRequest(stage: InterventionDTO, shiftRequest: MoveInterventionRequestDTO.ShiftEnum) {
        if (this.model == null) {
            this.componentService.getRootComponent().showToastMessage('warning', 'Selezionare un servizio');
        } else if (stage == null) {
            this.componentService.getRootComponent().showToastMessage('warning', 'Selezionare una tappa');
        } else {
            this.componentService.getRootComponent().mask();

            let request: MoveInterventionRequestDTO = {
                serviceCode: this.model.code,
                indexFrom: stage.idx,
                shift: shiftRequest
            };

            this.transportService.moveInterventionPosition(request).catch((e, o) => {
                this.componentService.getRootComponent().unmask();
                return [];
            }).subscribe(res => {
                if (res != null) {
                    let service: ServiceDTO = res.result;
                    if (service != null) {

                        if (service.interventionList) {
                            service.interventionList = service.interventionList.sort((n1, n2) => {
                                if (n1.idx > n2.idx) {
                                    return 1;
                                } else {
                                    return -1;
                                }
                            });
                        }

                        this.model.interventionList = service.interventionList;
                        // TODO INTEGRAZIONE STORMO
                        // TrasportiOrdinari:TSMain.moveFirst() -> stormoUpdateActivation(tmpSvc.getId());
                    }
                }
                this.componentService.getRootComponent().unmask();
            });

        }
    }

    public retriveStageData(stage: InterventionDTO) {
        if (this.model.serviceResourceList && this.model.serviceResourceList.length > 0) {
            this.cleanInterventionUnified();
            this.rilievoTappa = true;

            //creo un nuovo oggetto per fare la timbratura della tappa
            this.unifiedService = {
                trasportoCorrente: this.model,
                modificaTappePrecedenti: true,
                risorsaDelServizio: null,
                prenotazioneCorrente: stage,
                orarioTappa: new Date(),
                pauseType: this.staticService.getConfigValueByKey('LABEL_TEMPO_SOSTA', "1/2H")
            };
            //serve per riempire il campo sulla maschera
            (<any>this.unifiedService).orarioTappaObj = moment().format('HH:mm');
        } else {
            this.componentService.getRootComponent().showToastMessage('warning', 'Non ci sono mezzi assegnati sul servizio');
        }
    }

    public retriveStagePauseData(stage: InterventionDTO) {
        this.cleanInterventionUnified();
        //visualizzo il pannello per la pausa
        this.rilievoSostaTappa = true;

    }

    public async removeStage(stage: InterventionDTO) {
        this.componentService.getRootComponent().mask();

        let modelRequestRemove = {
            serviceId: this.model.id,
            interventionId: this.penotazioneSelected.id,
            bookingId: this.penotazioneSelected.bookingId,
            acceptRemoveBookingWithTimestamp: false
        };

        let hasTimestamp = await this.hasTimestampBooking(this.model.id, this.penotazioneSelected.id);
        let lastBooking: boolean = this.model.interventionList.length > 2 ? false : true;
        if (hasTimestamp.ok) {
            this.componentService.getRootComponent().unmask();
            this.componentService.getRootComponent().showConfirmDialog('Attenzione!',
                "Questa prenotazione è già stata servita da un mezzo. Continuare comunque?").then((result) => {
                    modelRequestRemove.acceptRemoveBookingWithTimestamp = true;
                    this.removeBookingFromService(modelRequestRemove, stage.bookingCode, lastBooking);
                }, (reason) => {
                    console.log("Rimozione prenotazione da servizio rifiutata e non effettuata ");
                    this.componentService.getRootComponent().unmask();
                    return;
                });
        } else {
            this.removeBookingFromService(modelRequestRemove, stage.bookingCode, lastBooking);
        }
    }

    public removeBookingFromService(model: any, bookingCode: string, lastBooking: boolean) {
        this.componentService.getRootComponent().mask();
        this.transportService.removeBookingFromService(model).catch((e, o) => {
            this.componentService.getRootComponent().unmask();
            return [];
        }).subscribe(res => {
            this.componentService.getRootComponent().unmask();
            this.componentService.getRootComponent().showToastMessage('success', "Rimozione prenotazione '" + bookingCode + "' dal servizio avvenuta con successo");
            if (lastBooking) {
                //update stormo
                this.sendStormoUpdateActivation(model.serviceId);
                setTimeout(() => {
                    this.router.navigate(['/sinottico-servizi']);
                }, 700);//Chiudi timeout
            } else {
                this.refreshService();
            }
        });
    }
    public async hasTimestampBooking(serviceId: string, interventionId: string): Promise<CheckResultDTO> {
        let model = {
            serviceId: this.model.id,
            interventionId: this.penotazioneSelected.id,
            bookingId: this.penotazioneSelected.bookingId
            //acceptRemoveBookingWithTimestamp: false
        };
        return this.transportService.hasTimestampBookingService(model).toPromise();
    }

    public stageProperty(stage: InterventionDTO) {
    }

    public addressDetail(stage: InterventionDTO) {
    }

    public stageModify(stage: InterventionDTO) {
        this.router.navigate(['/modifica-prenotazione', '2', stage.bookingId], { queryParams: { serviceCode: this.model.code, serviceId: this.model.id } });
    }

    // mezzi intervenuti
    public selectedMezziIntervenuti(el) {

    }


    public openWindow(type: 'prenotazioni' | 'servizi') {
        this.bcs.openChildren(environment.synURL, type, 600, 600);
    }


    public openCrewPopup(type: 'prenotazioni' | 'servizi') {
        let modal = this.modalService.open(CrewMemberModalComponent, { size: 'lg' });
        modal.componentInstance.serviceId = this.model.id;
    }

    

} 